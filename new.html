<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <link rel="icon" href="assets/images/icon.ico">
  <title></title>
  <link href="https://fonts.googleapis.com/css?family=Raleway" rel="stylesheet">

  <link rel="stylesheet" href="assets/css/bootstrap.min.css">
  <link rel="stylesheet" href="assets/css/style.css">

  <link rel="stylesheet" href="style.css">

</head>

<body>

  <!-------- Conteúdo -------->

  <div id="reservation-calendar"></div>
  



  <!-------- Javascript -------->

  <script src="assets/js/jquery-3.3.1.min.js"></script>
  <script src="assets/js/bootstrap.min.js"></script>

  <script>

    var _data = [
        { 
          date: "8-05-2019", 
          classroom: 1, 
          evento: "Reserva para Aula", 
          isReserve: true, 
          shift: "M" 
        },
        { 
          date: "15-05-2019", 
          classroom: 1, 
          evento: "Reserva para Curso", 
          isReserve: true, 
          shift: "T" 
        },
        { 
          date: "18-05-2019", 
          classroom: 1, 
          evento: "Aula de Biologia", 
          isReserve: false, 
          shift: "N" 
        },
        { 
          date: "24-05-2019", 
          classroom: 1, 
          evento: "Apresentação de TCC", 
          isReserve: false, 
          shift: "T" 
        },
        { 
          date: "24-05-2019", 
          classroom: 1, 
          evento: "Festa de Fim de Prova", 
          isReserve: false, 
          shift: "A" 
        },
        { 
          date: "28-05-2019", 
          classroom: 1, 
          evento: "Festa de Fim de Prova", 
          isReserve: false, 
          shift: "A" 
        }
      ]

    class ReservationCalendar{

      _defaultValues(){
        this.element = "reservation-calendar"
        this.weekName = ["Domingo", "Segunda", "Terça", "Quarta", "Quinta", "Sexta", "Sábado"]
        this.dayName = "Dia"
        this.daySeparator = [
          {
            id : "M",
            name : "Manhã"
          },
          {
            id : "T",
            name : "Tarde"
          },
          {
            id : "N",
            name : "Noite"
          },
          {
            id : "A",
            name : "Madruga"
          }
        ]
        this.varNames = {
          date : "date",
          event : "event",
          isReserve : "isReserve",
          shift: "shift"
        }
        this.today = new Date()
      }

      _overwriteValues(data){
        if (typeof(data)=="object"){
          $.each(data, (index, value) => { 
            this[index] = value
          });
        } else {
          throw new Error("Missing object parameters!")
        }
      }

      constructor(data = false){

        this._defaultValues()
        data ? this._overwriteValues(data) : NaN

        this._createStruct()
      }

      _addColToStruct(id){
        let auxString = ""
        this.daySeparator.forEach(element => {
          auxString += `
          <tr data-parent="${id}" data-turno="${element.id}"><th class="linha-turno" scope="row">${element.name}</th><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
          `
        })
        return auxString
      }
      
      _createStruct(){
        let template = `
          <div class="table-reserva d-flex justify-content-md-center"><div><table class="table table-bordered text-center col-md-12 table-hover"><thead class="thead-dark"><tr><th scope="col"></th><th scope="col">${this.weekName[0]}</th><th scope="col">${this.weekName[1]}</th><th scope="col">${this.weekName[2]}</th><th scope="col">${this.weekName[3]}</th><th scope="col">${this.weekName[4]}</th><th scope="col">${this.weekName[5]}</th><th scope="col">${this.weekName[6]}</th></tr></thead><tbody><tr data-parent="1" class="tr-dia"><th id="semana-1" class="linha-dia" scope="row">${this.dayName}</th><td data-sem="0"></td><td data-sem="1"></td><td data-sem="2"></td><td data-sem="3"></td><td data-sem="4"></td><td data-sem="5"></td><td data-sem="6"></td></tr> ${this._addColToStruct(1)}<tr class="table-separador" data-separador="1"><th scope="row"></th><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr><tr data-parent="2" class="tr-dia"><th id="semana-2" class="linha-dia" scope="row">${this.dayName}</th><td data-sem="0"></td><td data-sem="1"></td><td data-sem="2"></td><td data-sem="3"></td><td data-sem="4"></td><td data-sem="5"></td><td data-sem="6"></td></tr>${this._addColToStruct(2)}<tr class="table-separador" data-separador="2"><th scope="row"></th><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr><tr data-parent="3" class="tr-dia"><th id="semana-3" class="linha-dia" scope="row">${this.dayName}</th><td data-sem="0"></td><td data-sem="1"></td><td data-sem="2"></td><td data-sem="3"></td><td data-sem="4"></td><td data-sem="5"></td><td data-sem="6"></td></tr>${this._addColToStruct(3)}<tr class="table-separador" data-separador="3"><th scope="row"></th><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr><tr data-parent="4" class="tr-dia"><th id="semana-4" class="linha-dia" scope="row">${this.dayName}</th><td data-sem="0"></td><td data-sem="1"></td><td data-sem="2"></td><td data-sem="3"></td><td data-sem="4"></td><td data-sem="5"></td><td data-sem="6"></td></tr>${this._addColToStruct(4)}<tr class="table-separador" data-separador="4"><th scope="row"></th><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr><tr data-parent="5" class="tr-dia"><th id="semana-5" class="linha-dia" scope="row">${this.dayName}</th><td data-sem="0"></td><td data-sem="1"></td><td data-sem="2"></td><td data-sem="3"></td><td data-sem="4"></td><td data-sem="5"></td><td data-sem="6"></td></tr>${this._addColToStruct(5)}<tr class="table-separador" data-separador="5"><th scope="row"></th><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr><tr data-parent="6" class="tr-dia"><th id="semana-6" class="linha-dia" scope="row">${this.dayName}</th><td data-sem="0"></td><td data-sem="1"></td><td data-sem="2"></td><td data-sem="3"></td><td data-sem="4"></td><td data-sem="5"></td><td data-sem="6"></td></tr>${this._addColToStruct(6)}<tr class="table-separador" data-separador="6"><th scope="row"></th><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr></tbody></table></div></div>
        `
        $(`#${this.element}`).html(template)
        console.log("Struct created!")
      }

      _formatRealDate(date){
        let arrayDate = date.split("-")
        let year = arrayDate[0]
        let month = arrayDate[1] - 1
        let day = arrayDate[2]
        return {year, month, day}
      }

      _realDate(date){
        let dateFormated = this._formatRealDate(date)
        let realDate = new Date(
          dateFormated.year,
          dateFormated.month,
          dateFormated.day
        )
        return realDate
      }

      _formatDaysInMonth(date){
        let arrayDate = date.split("-")
        let year = arrayDate[0]
        let month = arrayDate[1]
        let day = 0
        return {year, month, day}
      }

      _daysInMonth(date){
        let dateFormated = this._formatDaysInMonth(date)
        let numberOfDaysInMonth = new Date(
          dateFormated.year,
          dateFormated.month,
          dateFormated.day
        ).getDate()
        return numberOfDaysInMonth
      }

      _formatDayOne(date){
        let arrayDate = date.split("-")
        let year = arrayDate[0]
        let month = arrayDate[1] - 1
        let day = 1
        return {year, month, day}
      }

      _weekNumberDayOne(date){
        let dateFormated = this._formatDayOne(date)
        let dayOne = new Date(
          dateFormated.year,
          dateFormated.month,
          dateFormated.day
        ).getDay()
        return dayOne
      }

      _dayBefore(date, daysBefore){
        let dateFormated = this._formatDayOne(date)
        let dayBefore = new Date(
          dateFormated.year,
          dateFormated.month,
          dateFormated.day - daysBefore
        ).getDate()
        return dayBefore
      }

      _generateCalendar(date){
        this._createStruct()
        let inputDate =  this._realDate(date)
        let numberDaysInMonth = this._daysInMonth(date)
        let weekNumberDayOne = this._weekNumberDayOne(date) // 0 to 6
        let trDia = $(".tr-dia [data-sem]")

        $.each(trDia, (index, value) => {
          if ((weekNumberDayOne) > index){
            // trDia[weekNumberDayOne-index].innerText = this._dayBefore(date, index)
            // let parentId = value.parentElement.getAttribute("data-parent")
            // let testeM = $(`[data-parent=${parentId}][data-turno=M] td`)
            // let testeT = $(`[data-parent=${parentId}][data-turno=T] td`)
            // let testeN = $(`[data-parent=${parentId}][data-turno=N] td`)
            // testeM[index].style.backgroundColor = '#eaeaea'
            // testeT[index].style.backgroundColor = '#eaeaea'
            // testeN[index].style.backgroundColor = '#eaeaea'
          } else if(index < weekNumberDayOne + numberDaysInMonth) {
            trDia[index].innerText = index - weekNumberDayOne + 1;
          } else if (trDia[weekNumberDayOne + numberDaysInMonth - 1].parentElement.getAttribute("data-parent") < value.parentElement.getAttribute("data-parent") ){
              let dataParentExtra = value.parentElement.getAttribute("data-parent")
              $(`[data-parent = ${dataParentExtra}]`).remove()
              $(`[data-separador = ${dataParentExtra}]`).remove()
              return false;
            }
        });
        
      }

      _updateReservations(data){
        $.each(data, (index, value) => { 
          try {
            let eventDay = FormatData.extractDay(value[this.varNames.date])
            let eventWeekDay = $(`.tr-dia td:contains(${eventDay})`).attr("data-sem")
            let parentNumber = $(`.tr-dia td:contains(${eventDay})`).parent().attr("data-parent")
            let arrayLine = $(`[data-parent='${parentNumber}'][data-turno='${value[this.varNames.shift]}'] td`)
            arrayLine[eventWeekDay].innerText = value[this.varNames.event]
            arrayLine[eventWeekDay].classList.value = value[this.varNames.isReserve] ? "s-confirmado" : "n-confirmado"
          } catch {
            console.warn(` Something went wrong when field 'shift[${value.shift}]' was being filled! Check if this field was setted.`);
          }
        });
      }

      updateCalendar(data, date){
        this._generateCalendar(date)
        this._updateReservations(data)
      }

    }

    class FormatData{
      static extractDay(date){
        let arrayDate = date.split("-")
        return arrayDate[0]
      }
    }

    a = new ReservationCalendar(
      {
        weekName : ["Dom", "Seg", "Ter", "Qua", "Qui", "Sex", "Sáb"],
        dayName : "Dia",
        varNames : {
          date : "date",
          event : "evento",
          isReserve : "isReserve",
          shift: "shift"
        }
      })

    a.updateCalendar(_data, '2019-05-0')

    
  </script>

</body>

</html>